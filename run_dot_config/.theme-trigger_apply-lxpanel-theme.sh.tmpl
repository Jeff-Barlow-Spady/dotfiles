#!/bin/bash
# Apply lxpanel theme from current theme's alacritty.toml
# Runs when dot_config/.theme-trigger.tmpl changes (theme change)
{{- if eq .chezmoi.os "linux" }}
set -euo pipefail

# Get theme from chezmoi data using proper path detection
CHEZMOI_DATA=""
if [[ -n "${CHEZMOI_DATA_DIR:-}" ]]; then
  CHEZMOI_DATA="${CHEZMOI_DATA_DIR}/.chezmoidata.yaml"
elif [[ -n "${XDG_DATA_HOME:-}" ]]; then
  CHEZMOI_DATA="${XDG_DATA_HOME}/chezmoi/.chezmoidata.yaml"
else
  CHEZMOI_DATA="${HOME}/.local/share/chezmoi/.chezmoidata.yaml"
fi

THEME="gruvbox"
if [[ -f "$CHEZMOI_DATA" ]]; then
  THEME=$(grep -E '^[[:space:]]*current_theme:' "$CHEZMOI_DATA" | sed 's/.*:[[:space:]]*"\(.*\)".*/\1/' | head -1)
fi
THEME="${THEME:-gruvbox}"

# Get chezmoi source dir
CHEZMOI_SOURCE_DIR="${CHEZMOI_SOURCE_DIR:-${HOME}/.local/share/chezmoi}"
if command -v chezmoi >/dev/null 2>&1; then
  CHEZMOI_SOURCE_DIR=$(chezmoi source-path 2>/dev/null || echo "$CHEZMOI_SOURCE_DIR")
fi
THEME_FILE="${CHEZMOI_SOURCE_DIR}/themes/${THEME}/alacritty.toml"
PANEL_CONFIG="${HOME}/.config/lxpanel/default/panel"

if [[ ! -f "$THEME_FILE" ]]; then
  echo "Theme file not found: $THEME_FILE" >&2
  exit 1
fi

# Extract colors from alacritty.toml
BG_COLOR=$(grep -E '^background = "0x[0-9a-fA-F]{6}"' "$THEME_FILE" | sed 's/.*"0x\([0-9a-fA-F]*\)".*/\1/' | head -1)
FG_COLOR=$(grep -E '^foreground = "0x[0-9a-fA-F]{6}"' "$THEME_FILE" | sed 's/.*"0x\([0-9a-fA-F]*\)".*/\1/' | head -1)

if [[ -z "$BG_COLOR" ]] || [[ -z "$FG_COLOR" ]]; then
  echo "Could not extract colors from $THEME_FILE" >&2
  exit 1
fi

# Update lxpanel config
if [[ -f "$PANEL_CONFIG" ]]; then
  # Update tintcolor (background)
  sed -i "s|^[[:space:]]*tintcolor=.*|    tintcolor=#${BG_COLOR}|" "$PANEL_CONFIG"
  
  # Update fontcolor (foreground)
  sed -i "s|^[[:space:]]*fontcolor=.*|    fontcolor=#${FG_COLOR}|" "$PANEL_CONFIG"
  
  # Reload lxpanel if running
  if pgrep -x lxpanel >/dev/null; then
    killall -HUP lxpanel 2>/dev/null || true
  fi
fi
{{- end }}

